
\chapter{Research Protocol}

\vcomment{List all decisions you make. Be very explicit.
	Current plan: Go into depth for certain portions in the implementations chapter.}

\section{Samples / Image Domain}\label{sec:NCS-data-set}

We ultimately perform a PCSVN extraction on a subset of 201 color placental images from a private database provided by the National Children's Study, which had been prepared for a different study. A detailed description of the data set is given in \cite{chang2017},
and a description of the cleaning and fixing procedure is given in \cite{almoussa-ucla-reu}. The samples are provided as XCF files (the native project file for GIMP) and contain four major layers.
\subsection{A representative sample}
The layers together give a hand tracing of the vascular network and perimeter. A sample of overlaid layers in a representative sample (with ID number ``BN0164923'') is given in \cref{fig:NCSlayers}.
% put this on it's own page close to it's first reference
\begin{figure}[p] \centering
	\subfloat[Fixed Placental Sample]{		\label{fig:NCSlayers-raw}\includegraphics[width=80mm]{{{T-BN0164923.raw}}}
		}
	\subfloat[Perimeter tracing]{
		\label{fig:NCSlayers-P}\includegraphics[width=80mm]{{{T-BN0164923_perimeter_overlay}}}
	}\\
	\subfloat[Arterial tracing]{
		\label{fig:NCSlayers-A}\includegraphics[width=80mm]{{{T-BN0164923_arteries_overlay}}}
		}
	\subfloat[Venous tracing]{
		\label{fig:NCSlayers-V}\includegraphics[width=80mm]{{{T-BN0164923_veins_overlay}}}
		}\\
	\subfloat[Total Vascular Network]{
		\label{fig:NCSlayers-T}\includegraphics[width=80mm]{{{T-BN0164923_all_layers_overlay}}}
		}
	% should i use the real sample names? or obfuscate?
\caption{A representative placental sample and tracing}
\label{fig:NCSlayers}
\end{figure}

Each layer is roughly 1954x1200 pixels (with some subtle variation).
In \cref{fig:NCSlayers-raw}, a cleaned, fixed placenta is placed on a table with a camera a fixed distance away, and a rule and penny (presumably for redundancy) to aid registration and calibration of the resolution.
\cref{fig:NCSlayers-P} is a tracing (in green) of the perimeter of the placenta. The point of umbilical cord insertion is notated in yellow. Two cyan marks are placed on consecutive centimeter markings on the ruler (the dots are enlarged and shown as a darker blue here for clarity).
\cref{fig:NCSlayers-A} and \cref{fig:NCSlayers-V} are both hand traces of the PCSVN, with a layer for each the arteries and veins. These layers are simultaneously overlain on the base image in\cref{fig:NCSlayers-T}. The coloration is meant to indicate the diameter of each vessel. The diameters are binned into 9 discrete widths, odd integers from 3 to 19 pixels. Vessels of smaller diameter are either binned to three or (quite frequently) left untraced.
The correspondence between pencil color and (binned) vessel width is given in \cref{tab:widthcolors}.

\begin{table}
	\centering
\begin{tabular}{ccc}
	\hline
	\rule[-1ex]{0pt}{2.5ex}
	vessel width & color (hex value) & color name \\
	\hline 
	\rule[-1ex]{0pt}{2.5ex}
	3 pixels &  \#ff006f &   magenta \\                                      
	\rule[-1ex]{0pt}{2.5ex}
	5 pixels & \#a80000  & dark red \\                                      
	\rule[-1ex]{0pt}{2.5ex}
	7 pixels &  \#a800ff & purple \\                                          
	\rule[-1ex]{0pt}{2.5ex}
	9 pixel s&  \#ff00ff  & light pink \\
	\rule[-1ex]{0pt}{2.5ex}
	11 pixels &  \#008aff & blue \\                                          
	\rule[-1ex]{0pt}{2.5ex}
	13 pixels &  \#8aff00 &   green \\                                        
	\rule[-1ex]{0pt}{2.5ex}
	15 pixels &  \#ffc800 &  gold \\                                    
	\rule[-1ex]{0pt}{2.5ex}
	17 pixels & \#ff8a00  &  orange \\                                         
	\rule[-1ex]{0pt}{2.5ex}
	19 pixels & \#ff0015   &  bright red  \\
	\hline
\end{tabular}
\caption{Vessel width color code}
\label{tab:widthcolors}
\end{table}


All in all, these hand-traced and rather labor intensive--requiring between 4 and 8 hours to trace a single sample. A closer look at many of the samples often reveals that a great deal of subjectivity in providing this ``ground truth,'' as it is not often clear what the underlying truth really is; often it's hard to see where the vein is, vascular networks are obscured by the umbilical stem, the blood in the vessels dries unevenly or ruptures, and the vessel seems to disappear momentarily. These situations and more will be showcased in our results section, where we will discuss methods to simulate the subjectivity of decision.


\subsection{Knowns and Unknowns}
Of course, we wish to simply operate on the placental sample itself, without any understanding of its provided tracing (except for judging the strength of our algorithm);
our goal is to develop an algorithm that can produce a ``ground truth'' tracing similar to \cref{fig:NCSlayers-T} or \cref{fig:NCSoutput-trace} without any user intervention.

For our purposes however, we will use a limited amount of information from the tracings, namely the provided placental perimeter (shown in green in \cref{fig:NCSlayers}). In developing a fully automated algorithm, it would be relatively straightforward to obtain this boundary ourselves using various techniques, such as an Active Contour Model \cite{activecontours} or, or even a simple edge finding algorithm followed by watershedding and largest object selection as in \cite{huynh2013filter}. We leave that for future work. We do use the traced placental perimeter at our own peril, however, since often there are tears in the side of the plate or large amounts of non-vascular content with large changes in height that are not adequately accounted for in the perimeter tracing.

Finally, we will consider the location of the umbilical insertion point as a ``known'', as the vessels around it are frequently impossible to see and we wish to exclude them from consideration. It is not unreasonable, however, to consider this to be a known--in future preparations of samples, we could simply require that this point be centered in image in a predictable location. Furthermore, we use its location as a convenience in data analysis--knowledge of this point does not inform our algorithm at all.


\section{Image Preprocessing}

Building a sample suitable for use in our algorithm from \cref{fig:NCSlayers} is relatively simple. We  zero  outside the boundary of the plate (so as to not waste computational time calculating the differential geometry of a ruler, say), and also generate a binary mask to identify the plate. Finally, our vessel layers are combined and given as a binary trace. Our preprocessed samples used by the algorithm are given in \cref{fig:exampleNCSoutput}.

These procedures are performed automatically on the 201 images in our data set using a custom GIMP plug-in, which performs various ``bucket fill'' operations, layer mergings, and thresholdings. For completeness sake, this plug-in (and an associated Scheme script which turns it into a batch operation) can be found in the Appendix.

\begin{figure}\label{fig:exampleNCSoutput} 	\centering
	\subfloat[Background Mask (in white)]{
		\label{fig:NCSoutput-mask}\includegraphics[width=80mm]{{{T-BN0164923.mask}}}
	}
	\subfloat[Sample with BG removed]{
		\label{fig:NCSoutput-base}\includegraphics[width=80mm]{{{T-BN0164923}}}
	} \\
	\subfloat[Grayscale]{
		\label{fig:NCSoutput-gray}\includegraphics[width=80mm]{{{T-BN0164923.L}}}
	}
	\subfloat[Trace / ``Ground Truth'']{
		\label{fig:NCSoutput-trace}\includegraphics[width=80mm]{{{T-BN0164923.trace}}}
	}
	\caption{Preprocessed files from an NCS sample}
\end{figure}

	As a point of technicality, the grayscale image in \cref{fig:NCSoutput-gray} is not actually produced directly by the extractor plug-in, but created when the 3 channel RGB image \cref{fig:NCSoutput-base} is imported at the start of the algorithm. This grayscale conversion is simply done for ease of analysis on the sample: although the Frangi filter is designed for arbitrary N-dimensional input \cite{frangi-paper}, an image with three color channels does not have 3 spatial dimensions. We therefore simply combine the information in three channels using the well-known and oft-implemented ITU-R 601-2 luma \cite{scipy}, or ``luminance'' transform:
	
	\begin{equation} \label{eq:luma_transform}
	L =  \frac{299}{1000}\ R + \frac{587}{1000}\ G + \frac{114}{1000}\ B
	\end{equation}
	It should be noted that this choice is not automatic--several other attempts have used the green channel unmodified, as in 
	All images are grayscale, $M,N$ pixels as a masked array (of type
	\texttt{numpy.ma.MaskedArray}), where pixels outside of the placental region are masked so they will not be considered by the algorithm. However, some standard
	implementations of algorithms, namely \texttt{numpy.gradient and scipy.signal.convolve2d} are not designed to handle masked regions. Although it would be of some interest to create an algorithm that, say, calculates a gradient or performs a convolution by a ``reflection'' across an arbitrary closed boundary (as opposed to the edge of the image matrix), we opted instead to simply exclude affected areas from consideration, and zero unwanted background pixels to speed up computation. This excluding function,
	\texttt{plate\_morphology.dilate\_plate}, ultimately relies on two functions
	provided by the Python library \texttt{scikit-image} \cite{skimage}. The first, \texttt{skimage.segmentation.find\_boundaries()}, takes the mask input (such as \cref{fig:NCSoutput-mask}) and calculates where differences in a morphological erosion and dilation occur. That boundary itself is then dilated by the desired factor. The second is a ``sparse'' implementation of binary dilation that is particularly efficient for our problem. An array of indices of the image where the 
	
	\begin{figure}  \label{fig:boundary-demo}
		\includegraphics[width=\textwidth]{boundary_dilation_demo}
		\caption{Demonstration of boundary dilation}
	\end{figure}
	
	\cref{fig:boundary-demo} doesn't really show what I want it to, but this is what it would look like. Repeat with a smaller border. Maybe the issue doesn't occur with these as much? 	In the image above, $\sigma=3$ and border radius is 80 and all it does is get 	rid of the stupid natural boundary, not a weird frangi response. Which is important in itself, but I was having an error just between the edge of the image.
	
	The code for the above can by found by running \texttt{plate\_morphology.py} as a top-level script (that is, within the ``\texttt{if \_\_name\_\_ == \_\_main\_\_}'' block of the file).
	
	
	\subsection{Variations in the Data Set and Imperfections of the Ground Truth}
	
	
\section{Multiscale Setup}

	Our multiscale Frangi filter requires a list of scales at which to probe. Each scale is chosen to accentuate features of a particular size, i.e. vessels of a particular radius. This  list of scales is denoted as $\Sigma := \{ \sigma_1, \sigma_2, \dots, \sigma_N\}$. 
	 
	The smallest one should be an effective size where details are expected to be found, and the largest should be an effective size as well. In fact, following \cite{Koenderink} it is reasonable and natural to select these logarithmically; that is,
	for some selected inputs $m < M$ we have
	
	\begin{equation}
	\sigma_1 = 2^{m} \; , \; \sigma_{j} = 2^{\left(m+\frac{M-m}{N-1}j\right)} \; , \; \sigma_N = 2^{M} \end{equation}
	
	That is, the exponents are spaced linearly from $m$ to $M$. This is achieved by the command
	\texttt{np.logspace(m,M,num=N)}. The idea is that the filter will respond better at its particular scale, but there are diminishing returns as $\sigma$ increases. While the filter's response may vary substantially between, say $\sigma=2$ and $\sigma=3$, there will be not be a substantial difference in response between, say, $\sigma=46$ and $\sigma=47$. There was an earlier benefit as well, that is still worth mentioning for historical reasons. Previously, computing the vesselness measure was very expensive, and thus it was simply not feasible to collect so many large scale readings. This is moot with the development of FFT-based Frangi filter.
	
	If there is no particular care taken in selecting a minimum and maximum range at which to probe, then we should assure that there is no noise being introduced at either ends, especially if the Frangi filter at which   ``throw out'' bad ones somehow. We will approach this issue in our discussion of ``variable thresholding.''
	
	
	
	
	
	Convolve this via fft transform to get $L_{\sigma_i}$
	

\section{Applying Vesselness Measure}
Calculate the Hessian matrix of  and then the eigenvalues using the function \texttt{hfft.fft\_hessian}.

\begin{figure}
	\includegraphics[width=\textwidth]{sweep_stitched_plate}
	\caption{Frangi vesselness score at several scales}
\end{figure}
\begin{figure}
	\includegraphics[width=\textwidth]{sweep_stitched_inset}
	\caption{Frangi vesselness score at several scales (inset)}
\end{figure}
\section{Scale-space post-processing}
\section{Multiscale Merging}
\section{Cleanup/Postprocessing}
\section{Measurements}

	\subsection{Erode plate / dilate boundary}
	
	Our function considers the placenta as a nonzero surface but the surface outside is zero (or, in many situations, masked). We're currently not implementing any way to ``reflect'' along the border, so instead the second degree behavior of the surface there will be incorrect in an area proportional to the scale size.
	
	Describe how that function works. Earlier efforts are wrong, whatever.
	
	The are which is affected should be larger than just the standard dropoff the gaussian however, since we're interested
	in second derivative information.
